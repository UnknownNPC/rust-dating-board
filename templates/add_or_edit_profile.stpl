<!DOCTYPE html>
<html lang="en">

<head>
    <% let head_title="Додати нову анкету" ; %>
        <% include!("./includes/head_body.stpl"); %>
            <link rel="stylesheet" href="static/css/bootstrap-icons.min.css" crossorigin="anonymous">
            <link href="static/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
</head>

<body>
    <% include!("./includes/nav.stpl"); %>

        <div class="container">
            <p class="h1">
                <% if data_context.is_edit_mode { %>
                    Редагування анкети
                <% } else { %>
                    Нова анкета
                <% } %>        
            </p>
            <% 
            fn get_error_code_by_field(name: &str, error_context: &ErrorContext) -> String {
                let error = error_context.data.get(name);
                error.map(|f| f.to_owned()).unwrap_or_default()
            }
    
            fn get_translation(code: &String) -> String {
                match code.as_str() {
                    "is_empty" => String::from("Поле не може бути пустим"),
                    "length" => String::from("Невалідна довжина значення"),
                    "range" => String::from("Значення не у валідному діапазоні"),
                    _ => String::from("")
                }
            }
            %>    
            <form action="/add_or_edit_profile" method="post">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <% let error_or_empty = get_translation(&get_error_code_by_field("name", error_context)); %>
                        <% let input_class_value = if error_or_empty.is_empty() { "" } else { "is-invalid" }; %>
                        <input type="text" aria-describedby="name_help" class="form-control <%= input_class_value %> " name="name" id="name_id"
                            value="<%= data_context.name %>" placeholder="Ім'я">
                            <small id="name_help" class="form-text text-muted">
                                Від 3 до 10 символів
                            </small>
                         <% if !error_or_empty.is_empty() { %>
                            <div class="invalid-feedback">
                                <%= error_or_empty %>
                              </div>
                         <% } %>       
                    </div>
                    <div class="form-group col-md-4">
                        <% let error_or_empty = get_translation(&get_error_code_by_field("height", error_context)); %>
                        <% let input_class_value = if error_or_empty.is_empty() { "" } else { "is-invalid" }; %>
                        <input aria-describedby="height_help" placeholder="Зріст" type="number" 
                            class="form-control <%= input_class_value %>" name="height" id="height_id" 
                        <% if data_context.height==0 { %>
                            value=""
                        <% } else { %>
                            value="<%= data_context.height %>"
                        <% } %> >
                        <small id="height_help" class="form-text text-muted">
                            Від 100 до 220
                        </small>
                        <% if !error_or_empty.is_empty() { %>
                            <div class="invalid-feedback">
                                <%= error_or_empty %>
                              </div>
                         <% } %>  
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group input-group col-md-4">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="phone_prefix">+380</span>
                        </div>
                        <% let error_or_empty = get_translation(&get_error_code_by_field("phone_number", error_context)); %>
                        <% let input_class_value = if error_or_empty.is_empty() { "" } else { "is-invalid" }; %>
                        <input type="text" class="form-control <%= input_class_value %>" aria-describedby="phone_prefix" name="phone_number"
                            id="phone_number_id" value="<%= data_context.phone_number %>" placeholder="Телефон">
                        <% if !error_or_empty.is_empty() { %>
                            <div class="invalid-feedback">
                                <%= error_or_empty %>
                              </div>
                         <% } %>
                    </div>
                    <div class="form-group col-md-4">
                        <% let error_or_empty = get_translation(&get_error_code_by_field("city", error_context)); %>
                        <% let input_class_value = if error_or_empty.is_empty() { "" } else { "is-invalid" }; %>
                        <select class="custom-select <%= input_class_value %>" name="city" id="city_id">
                            <% if data_context.city.is_empty() { %>
                                <option value="" selected>Виберіть місто</option>
                            <% } %>
                            <% fn translate(city: &String) -> String {
                                if city == "harkiv" {
                                    String::from("Харків")
                                } else if city == "kiev" {
                                    String::from("Київ")
                                } else if city == "odesa" {
                                    String::from("Одеса")
                                } else if city == "lviv" {
                                    String::from("Львів")
                                } else {
                                    String::from("")
                                }
                               }
                               for city in &nav_context.all_cities { %>
                                    <option 
                                    
                                    <% if &data_context.city == city { %>
                                        selected
                                    <% } %>
                                    
                                    
                                    value="<%= city %>">
                                        <%= translate(city) %>
                                    </option>
                                <% } %>
                        </select>
                        <% if !error_or_empty.is_empty() { %>
                            <div class="invalid-feedback">
                                <%= error_or_empty %>
                              </div>
                         <% } %>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <% let error_or_empty = get_translation(&get_error_code_by_field("description", error_context)); %>
                        <% let input_class_value = if error_or_empty.is_empty() { "" } else { "is-invalid" }; %>
                        <textarea aria-describedby="description_help" class="form-control <%= input_class_value %>" name="description" id="description_id"
                            rows="4" placeholder="Опис"><%= data_context.description %></textarea>
                        <small id="description_help" class="form-text text-muted">
                                Від 10 до 600 символів
                        </small>
                        <% if !error_or_empty.is_empty() { %>
                            <div class="invalid-feedback">
                                <%= error_or_empty %>
                              </div>
                         <% } %>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <div class="file-loading">
                            <input id="photo-files" name="new_profile_photo" type="file" multiple>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <button type="submit" class="btn btn-primary mx-auto d-block">
                            <% if data_context.is_edit_mode { %>
                               Оновити  
                            <% } else { %>
                               Опублікувати
                            <% } %>       
                        </button>
                    </div>
                </div>
                <% if data_context.is_edit_mode && data_context.id.is_some() { %>
                    <input type="hidden" name="profile_id" value="<%= data_context.id.as_ref().unwrap() %>">   
                <% } %> 
                <input type="hidden" name="captcha_token" id="captcha_token" />
            </form>
        </div>

</body>

<% include!("./includes/extra_scripts.stpl"); %>
    <script src="static/js/fileinput.min.js"></script>
    <script src="static/js/locales/ru.js"></script>
    <script src="static/js/locales/ua.js"></script>
    <script>
        $(document).ready(function () {
            var $el1 = $("#photo-files");
            $el1.fileinput({
                uploadUrl: "/profile_photo/upload",
                enableResumableUpload: false,
                maxFileCount: 10,
                duplicate: false,
                maxSize: 15728640,
                allowedFileExtensions: ["jpg", "jpeg"],
                language: 'ua',
                initialPreviewAsData: true,
                overwriteInitial: false,

                initialPreview: [
                    <% for photo_url in & data_context.init_photos.initial_preview { %>
                        "<%= photo_url %>",
                    <% } %>
                ],
                initialPreviewConfig: [
                    <% for init_photo in & data_context.init_photos.initial_preview_config { %>
                        {
                            caption: '<%= init_photo.caption %>',
                            width: '120px',
                            url: '<%= init_photo.url %>',
                            key: <%= init_photo.key %>,
                            size: <%= init_photo.size %>
                        },
                    <% } %>
                ],
                browseLabel: "Вибрати світлини",
                dropZoneTitle: "Перетягніть світлини у зону автоматичної загрузки",
                dropZoneClickTitle: "<br\>(або нажміть для вибору файлів)",
                fileActionSettings: {
                    showZoom: false,
                    showRotate: false,
                    showUpload: false,
                    showDrag: false,
                },
                showPause: false,
                showCancel: false,
                showBrowse: false,
                showUpload: false,
                showCaption: false,
                showRemove: false,
                showClose: false,
                <% if data_context.is_edit_mode && data_context.id.is_some() { %>
                    uploadExtraData:{ 
                        profile_id: <%= data_context.id.as_ref().unwrap() %>
                    },        
                <% } %>    
                browseOnZoneClick: true
            }).on('filebatchselected', function (event, previewId, index, fileId) {
                $el1.fileinput("upload");
            });
        });
    </script>
    <script>
        grecaptcha.enterprise.ready(function() {
            grecaptcha.enterprise.execute('6LfnsvEkAAAAALx2ZI1eiXPo-wFKaFWV7ceUBcjh', {action: 'add_or_edit_profile'})
                .then(function(token) {
                    document.getElementById('captcha_token').value = token;
            });
        });
    </script>

</html>