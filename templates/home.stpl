<!DOCTYPE html>
<html lang="en">

<head>
    <% let head_title="Голова сторінка" ; %>
    <% include!("./includes/head_body.stpl"); %>
</head>

<body>
    <% let active_tab = "index"; %>
    <% include!("./includes/nav.stpl"); %>

        <div class="container">

            <% if data_context.message_code.is_some() { %>
                <% let message = data_context.message_code.as_ref().unwrap();
                   fn get_type_and_message(message: &String) -> (String, String) {
                      match message.as_str() {
                            "profile_added" => ("alert-success".to_string(), "Анкета опублікована".to_string()),
                            "profile_updated" => ("alert-success".to_string(), "Анкета оновлена".to_string()),
                            "sign_in_ok" => ("alert-success".to_string(), "Вхід виконано".to_string()),
                            "sign_out_ok" => ("alert-success".to_string(), "Вихід виконано".to_string()),
                            "server_error" => ("alert-danger".to_string(), "Помилка сервера. Спробуйте пізніше".to_string()),
                            "unauthorized" => ("alert-warning".to_string(), "Авторизуйтесь і спробуйте ще раз".to_string()),
                            "bad_request" => ("alert-danger".to_string(), "Данні вже невалідні, спробуйте знов".to_string()),
                            "bot_detected" => ("alert-danger".to_string(), "Підозріла активність. Спробуйте пізніше".to_string()),
                            _ => ("error".to_string(), "error".to_string())
                      }
                } %>
                <div class="mt-3 mb-0 alert  <%= get_type_and_message(&message).0 %> alert-dismissible fade show" role="alert">
                    <%= get_type_and_message(&message).1 %>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
            <% } %>

            <% if nav_context.is_search && !data_context.profiles.is_empty() { %>
                <p class="h1 pt-3">Результати пошуку <%= data_context.search_text.as_ref().unwrap() %></p>
            <% } else if nav_context.is_user_profiles { %>
                <p class="h1 pt-3">Мої анкети</p>
            <% } else if !nav_context.current_city.is_empty() { %>
                <% fn translate(city: &String) -> String {
                    if city == "harkiv" {
                        String::from("Харкова")
                    } else if city == "kiev" {
                        String::from("Київа")
                    } else if city == "odesa" {
                        String::from("Одеси")
                    } else if city == "lviv" {
                        String::from("Львова")
                    } else {
                        String::from("НЕВІДОМО")
                    }
                } %>
                <p class="h1 pt-3">Анкети міста <%= translate(&nav_context.current_city) %></p>
            <% } else if !data_context.profiles.is_empty() { %>
                <p class="h1 pt-3">Анкети України</p>
            <% } %>

            <% if data_context.profiles.is_empty() { %>
                <h2 class="text-center pt-3">Нажаль нічого не знайдено</h2>
            <% } else { %>
                <div class="card-columns">
                    <% fn translate(city: &String) -> String {
                        if city == "harkiv" {
                            String::from("Харків")
                        } else if city == "kiev" {
                            String::from("Київ")
                        } else if city == "odesa" {
                            String::from("Одеса")
                        } else if city == "lviv" {
                            String::from("Львів")
                        } else {
                            String::from("")
                        }
                    }
                    %>
                    <% for profile in &data_context.profiles { %> 
                        <div class="card" style="background-color: #e3f2fd;">
                            <% if profile.photo_url_opt.is_some() { %>
                            <img class="card-img-top" src="<%= profile.photo_url_opt.as_ref().unwrap() %>" alt="photo">
                            <% } %>
                            <div class="card-header d-flex p-2">
                                <b><%= profile.name %></b>
                                <% if nav_context.is_user_profiles { %>
                                    <span class="ml-auto card-icons-box">
                                        <a href="/edit_profile?id=<%= profile.id %>">
                                            <i class="fas fa-pen fa-md mr-2" title="Редагувати"></i>
                                        </a>
                                        <a class="delete_profile_link" data-toggle="modal" data-id="<%= profile.id %>" href="#">
                                            <i class="fas fa-trash fa-md" title="Видалити"></i>
                                        </a>
                                    </span>
                                <% } %>

                            </div>
                            <div class="card-body p-2">
                                <p class="card-text"><%= profile.short_description %>...</p>
                                <a href="/view_profile?id=<%= profile.id %>" class="stretched-link"></a>
                            </div>
                            <div class="card-footer d-flex p-2">
                                <small class="text-muted"><%= profile.date_create %></small>
                                <small class="text-muted ml-auto"><%= translate(&profile.city) %></small>
                            </div>
                        </div>
                            
                    <% } %>
                </div>
            <% } %>

            <% if !nav_context.is_user_profiles && !nav_context.is_search { %>
                <% let city_query_param = if nav_context.current_city.is_empty() { 
                    String::from("")
                } else { 
                    format!("&filter_city={}", nav_context.current_city)
                };
                %>
                <nav aria-label="navigation" class="pt-3">
                    <ul class="pagination justify-content-center">
                        <% if data_context.pagination.has_previous { %>
                            <li class="page-item">
                                <a class="page-link" href="/?page=<%= &data_context.pagination.current - 1 %><%= city_query_param %>" tabindex="-1">Попередня</a>
                            </li>
                        <% } else { %>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Попередня</a>
                            </li>
                        <% } %>
                        <% for page_index in 1..data_context.pagination.total + 1 { %>
                                <!-- select <li> -->
                                <% if page_index == data_context.pagination.current { %>
                                    <li class="page-item active">
                                <% } else { %>
                                    <li class="page-item">
                                <% } %>
                                        <a class="page-link" href="/?page=<%= page_index %><%= city_query_param %>"><%= page_index %></a>
                                    </li>
                        <% } %>

                        <!-- disabled here -->
                        <% if data_context.pagination.has_next { %>
                            <li class="page-item">
                                <a class="page-link" href="/?page=<%= &data_context.pagination.current + 1 %><%= city_query_param %>" tabindex="-1">Наступна</a>
                            </li>
                        <% } else { %>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Наступна</a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>

            <!-- delete profile modal -->
            <div class="modal fade" id="delete_profile_modal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteModalLabel">Видалення анкети</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                        Ви впевнені, що хочете видалити анкету?
                    </div>
                    <div class="modal-footer">
                      <form action="/profile/delete" method="post">
                        <input id="id_input" name="id" type="hidden" value=""/>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Відмінити</button>
                        <button type="submit" class="btn btn-primary">Видалити</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>    

        </div>

</body>

<% include!("./includes/extra_scripts.stpl"); %>
<script>
    $(document).on("click", ".delete_profile_link", function () {
     var delete_profile_id = $(this).data('id');
     $("#delete_profile_modal #id_input").val(delete_profile_id);
     $('#delete_profile_modal').modal('show')
});
</script>

</html>